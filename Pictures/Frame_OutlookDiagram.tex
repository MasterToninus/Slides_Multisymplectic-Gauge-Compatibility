%+------------------------------------------------------------------------+
%| Diagram with Overlays: Gauge square Diagram - symplectic case
%| Author: Antonio miti
%+------------------------------------------------------------------------+


\documentclass[beamer,handout,tikz]{standalone}
\usepackage{tikz-cd}
\usepackage{mathtools}
\usepackage{stackengine}
\usepackage{amsfonts}
\usetikzlibrary{decorations.pathmorphing}
\usetikzlibrary{cd, fit}

	%Credit: https://tex.stackexchange.com/questions/99119/beamer-problematic-use-of-visible-and-only-in-combination-with-tikz-to-draw-a
  \tikzset{
    invisible/.style={opacity=0},
    visible on/.style={alt=#1{}{invisible}},
    alt/.code args={<#1>#2#3}{%
      \alt<#1>{\pgfkeysalso{#2}}{\pgfkeysalso{#3}} % \pgfkeysalso doesn't change the path
    },
  }

\definecolor{grey}{rgb}{0.30, 0.30, 0.30}

\begin{document}
	%
	%
	\begin{tikzcd}[column sep= normal,row sep=normal,
		/tikz/execute at end picture={
    			\node (large) [rectangle,dashed, draw, fit=(A1) (A2),label=below:{\scriptsize{\emph{$L_\infty$ algebras cat.}}}] {};
    			\node (large) [visible on=<1->,rectangle,dashed, draw, fit=(B1) (B2),label=below:{\scriptsize{\emph{DGLAs cat.}}}] {};
    			\node (large) [visible on=<1->,rectangle,dashed, draw, fit=(C1) (C2),label=below:{\scriptsize{\emph{$Q$-graded mafds.}}}] {};
    			\node (large) [visible on=<1->,rectangle,dashed, draw, fit=(D1) ,label=above:{\scriptsize{\emph{Leib. algs. cat.}}}] {};
  		} ]
  		%	
		& 
		& 
		& |[visible on=<1->,alias=D1]| \textrm{Leib}(M,\omega) 
		\ar[r,rightsquigarrow,visible on=<7->]
		&|[visible on=<7->,alias=A1]| L_\infty[\textrm{Leib}(M,\omega)] 
		\ar[d,dashed,dash, visible on=<8->,"?"]
		\\
		%
		& 
		& 
		&  
		& |[visible on=<1->]| L_\infty(M,\omega)
		\ar[d,hook, visible on=<1->,"\Psi_\omega"] 
		\\
		%
		(M,\omega) 
		\ar[r,rightsquigarrow]
		\ar[urrrr,bend left=15,rightsquigarrow]
		\ar[uurrr,bend left=15,rightsquigarrow]
		\ar[dr,rightsquigarrow,bend right=15, visible on=<2->]
		& |[visible on=<1->]| \parbox{4cm}{\centering \emph{\footnotesize $\omega$-twisted Higher Cour. algoid.} $(TM\oplus\wedge^{n-1}T^*M,\dots)$}
		\ar[r,leftrightarrow, visible on=<1->]
		& |[visible on=<1->,alias=C1]| \mathcal{M} = T^\ast[n]T[1] M
		\ar[r,rightsquigarrow, visible on=<1->]
		& |[visible on=<1->,alias=B1]| \mathcal{C}_{\mathcal{M}}		
		\ar[r,rightsquigarrow, visible on=<1->]
		& |[visible on=<1->]| L_\infty(E,\omega)
		\ar[d,dashed,dash, visible on=<6->,"?"]
		\\
		%
		& |[visible on=<2->]| \parbox{4cm}{\centering \emph{\footnotesize Higher Dirac struct.\\} $\text{graph}(\omega)$} 
		\ar[d,hook,visible on=<2->]
		\ar[r,leftrightarrow, visible on=<3->]
		& |[visible on=<3->]| \parbox{2cm}{\centering \emph{\footnotesize Lagrangian submfd. \\} $\mathcal{D}_\omega$}  
		\ar[d,hook,visible on=<3->]
		\ar[r,rightsquigarrow,visible on=<4->]
		& |[visible on=<4->]|\mathcal{C}_{\mathcal{D}_\omega}
		\ar[r,rightsquigarrow,visible on=<5->]
		& |[visible on=<5->]| L_\infty(\mathcal{D}) 
		\ar[d,dashed,dash, visible on=<6->,"?"]
		\\
		%
		& |[visible on=<2->]| \parbox{4cm}{\centering \emph{\footnotesize Standard Higher Cour. algoid.} $(TM\oplus\wedge^{n}T^*M,\dots)$} 
		\ar[r,leftrightarrow, visible on=<3->]
		& |[visible on=<3->,alias=C2]|\mathcal{N} = T^\ast[n+1]T[1] M 
		\ar[r,rightsquigarrow,visible on=<4->]
		& |[visible on=<4->,alias=B2]|\mathcal{C}_{\mathcal{N}}
		\ar[r,rightsquigarrow,visible on=<5->]
		& |[visible on=<5->,alias=A2]| L_\infty(\mathcal{N})
 	\end{tikzcd}		
	%
%	%
%	\begin{tikzcd}[column sep= small,row sep=small,
%		/tikz/execute at end picture={
%    		\node (large) [rectangle,dashed, draw, fit=(A1) (A2) (A3),label=below:{\scriptsize{\emph{Lie algebras cat.}}}] {};
%  		}]	
%%   execute at end picture={
%%     \node[label=below:{Symp.Mfds.},dashsquare=(tikz@f@1-1-1)(tikz@f@1-4-1)]{};
%%     \node[label=below:{Lie.Alg.oids},dashsquare=(tikz@f@1-1-4)(tikz@f@1-4-4)]{};
%%     \node[label=below:{Lie.Algs},dashsquare=(tikz@f@1-4-2)(tikz@f@1-2-4)]{};
%%		}
%		|[visible on=<1-4>]|\color{grey}{(M,\omega)}
%		\ar[drr,grey,visible on=<1-4>,rightsquigarrow,"\text{observables}",shift right=.5em]
%		\ar[rrrrr,grey,visible on=<1-4>,rightsquigarrow,"\text{twisted standard Lie algebroid}"]
%		\ar[dddd,grey,visible on=<2-4>,rightsquigarrow,sloped,"\text{gauge transf.}"']
%		&[-1.5em] &[-1em] & & 
%		&[-4em] |[visible on=<1-4>]|\color{grey}(TM \oplus \mathbb{R},\rho, [\cdot,\cdot]_\omega)
%		\ar[dl,grey,visible on=<1-4>,rightsquigarrow]
%		\ar[dddd,grey,visible on=<3-4>,sloped,"\text{B-transf.}"]
%%
%	\\[.5em]
%%
%		& \phantom{\big(}
%		& |[visible on=<1->,alias=A1]|\big(C^\infty(M),\lbrace\cdot,\cdot\rbrace_\omega\big) 
%		\ar[rr,visible on=<1->,"\Psi"]
%		\ar[ddrr,visible on=<8->,phantom,blue,"\circlearrowright"]
%		&
%		& |[visible on=<1->]|\big(\Gamma(TM\oplus \mathbb{R}),[\cdot,\cdot]_\omega\big)
%		\ar[dd,sloped,"\sim",visible on=<4->]
%		&
%%		 
%	\\
%%
%		&|[visible on=<6->,alias=A2]|\mathfrak{g} \ar[ur,"f",every label/.style={xshift=-2ex,yshift=.5ex},visible on=<7->]\ar[dr,"\tilde{f}"',every label/.style={xshift=-2ex,yshift=-.75ex},visible on=<7->]& 
%		& & &
%%
%	\\
%%
%		& &|[visible on=<2->]|\big(C^\infty(M),\lbrace\cdot,\cdot\rbrace_{\tilde{\omega}}\big)
%		\ar[rr,visible on=<2->,"\Psi"]	
%		& 
%		&
%		|[visible on=<2->,alias=A3]|\big(\Gamma(TM\oplus \mathbb{R}),[\cdot,\cdot]_{\tilde{\omega}}\big)
%		&
%%		
%	\\[.5em]
%%	
%		|[visible on=<2-4>]|\color{grey}(M,\tilde{\omega}) 
%		\ar[rrrrr,visible on=<2-4>,grey,rightsquigarrow]
%		\ar[urr,visible on=<2-4>,grey,rightsquigarrow,sloped,shift left=.5em]
%		& \phantom{\big(} & & &
%		& |[visible on=<2-4>]|\color{grey}(TM \oplus \mathbb{R},\rho,[\cdot,\cdot]_{\tilde{\omega}}) 
%		\ar[ul,grey,visible on=<2-4>,rightsquigarrow]
% 	\end{tikzcd}	
\end{document}

	